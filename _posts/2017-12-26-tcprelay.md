---
title: tcprelay ğŸ’Œ
---
Introduce to TCPRelay
=====================

EventLoop äº‹ä»¶å‘ç”Ÿäº†, éœ€è¦å¤„ç†å™¨è¿›è¡Œå¤„ç†, åœ¨è¿™é‡Œå¤„ç† TCP çš„æµç¨‹. åœ¨ `local.py` é‡Œé¢æœ‰è¿™ä¹ˆä¸€è¡Œä»£ç  `tcp_server = tcprelay.TCPRelay(config, dns_resolver, True)`, åˆ›å»º TCP çš„æœåŠ¡å™¨. è¿˜æœ‰è¿™ä¹ˆä¸€è¡Œ `tcp_server.add_to_loop(loop)`, å°†å…¶æ·»åŠ è¿›å…¥äº‹ä»¶è½®è®­å™¨, å‘ç”Ÿäº‹ä»¶çš„æ—¶å€™, è°ƒç”¨è¿™é‡Œçš„æ–¹æ³•æ¥å¤„ç† TCP è¯·æ±‚.

TL;DR
------

<!-- TODO: add TL;DR -->

å¯¼å…¥æ¨¡å—
-------

```python
from __future__ import absolute_import, division, print_function, \
    with_statement

import time
import socket
import errno
import struct
import logging
import traceback
import random

from shadowsocks import cryptor, eventloop, shell, common
from shadowsocks.common import parse_header, onetimeauth_verify, \
    onetimeauth_gen, ONETIMEAUTH_BYTES, ONETIMEAUTH_CHUNK_BYTES, \
    ONETIMEAUTH_CHUNK_DATA_LEN, ADDRTYPE_AUTH
```

å¼•å…¥å†…ç½®æ¨¡å—, è¿™é‡Œå°¤å…¶è¦æ³¨æ„ `struct` æ¨¡å—, åˆæ˜¯å’Œ C æ‰“äº¤é“çš„ ğŸ‘€ æ¨¡å—. ä» `shadowsocks` æ¨¡å—å¼•å…¥ `crypto` åŠ å¯†æ¨¡å—, å¯¼å…¥ `eventloop` æ¨¡å—, ä¸»è¦æ˜¯ç”¨åˆ°é‡Œé¢çš„ä¸€äº›å¸¸é‡(POLL\_IN, POLL\_OUT, etc.)

æ¨¡å—å¸¸é‡å®šä¹‰
----------

```python
# we clear at most TIMEOUTS_CLEAN_SIZE timeouts each time
TIMEOUTS_CLEAN_SIZE = 512
```

ä¸€æ¬¡æœ€å¤šæ¸…é™¤çš„è¿‡æœŸ socket çš„æ•°é‡, å¦‚æœè¶…æ—¶çš„ socket è¶…è¿‡äº†è¿™ä¸ªä¸´ç•Œç‚¹, åˆ™åªå¤„ç† 512 ä¸ª, å‰©ä½™ç­‰å¾…ä¸‹æ¬¡å¤„ç†, ä¸»è¦æ˜¯ä¸ºäº†èƒ½åŠæ—¶å¤„ç†å‘ç”Ÿçš„äº‹ä»¶, ä¸è‡³äºåœ¨è¶…æ—¶è¯·æ±‚è¿‡å¤šçš„æ—¶å€™å¯¼è‡´åç»­äº‹ä»¶çš„å¤„ç†è¢«å»¶è¿Ÿ.
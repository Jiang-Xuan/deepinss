---
title: tcprelay ğŸ’Œ
---
Introduce to TCPRelay
=====================

EventLoop äº‹ä»¶å‘ç”Ÿäº†, éœ€è¦å¤„ç†å™¨è¿›è¡Œå¤„ç†, åœ¨è¿™é‡Œå¤„ç† TCP çš„æµç¨‹. åœ¨ `local.py` é‡Œé¢æœ‰è¿™ä¹ˆä¸€è¡Œä»£ç  `tcp_server = tcprelay.TCPRelay(config, dns_resolver, True)`, åˆ›å»º TCP çš„æœåŠ¡å™¨. è¿˜æœ‰è¿™ä¹ˆä¸€è¡Œ `tcp_server.add_to_loop(loop)`, å°†å…¶æ·»åŠ è¿›å…¥äº‹ä»¶è½®è®­å™¨, å‘ç”Ÿäº‹ä»¶çš„æ—¶å€™, è°ƒç”¨è¿™é‡Œçš„æ–¹æ³•æ¥å¤„ç† TCP è¯·æ±‚.

TL;DR
------

<!-- TODO: add TL;DR -->

å¯¼å…¥æ¨¡å—
-------

```python
from __future__ import absolute_import, division, print_function, \
    with_statement

import time
import socket
import errno
import struct
import logging
import traceback
import random

from shadowsocks import cryptor, eventloop, shell, common
from shadowsocks.common import parse_header, onetimeauth_verify, \
    onetimeauth_gen, ONETIMEAUTH_BYTES, ONETIMEAUTH_CHUNK_BYTES, \
    ONETIMEAUTH_CHUNK_DATA_LEN, ADDRTYPE_AUTH
```

å¼•å…¥å†…ç½®æ¨¡å—, è¿™é‡Œå°¤å…¶è¦æ³¨æ„ `struct` æ¨¡å—, åˆæ˜¯å’Œ C æ‰“äº¤é“çš„ ğŸ‘€ æ¨¡å—. ä» `shadowsocks` æ¨¡å—å¼•å…¥ `crypto` åŠ å¯†æ¨¡å—, å¯¼å…¥ `eventloop` æ¨¡å—, ä¸»è¦æ˜¯ç”¨åˆ°é‡Œé¢çš„ä¸€äº›å¸¸é‡(POLL\_IN, POLL\_OUT, etc.)

æ¨¡å—å¸¸é‡å®šä¹‰
----------

```python
# we clear at most TIMEOUTS_CLEAN_SIZE timeouts each time
TIMEOUTS_CLEAN_SIZE = 512
```

ä¸€æ¬¡æœ€å¤šæ¸…é™¤çš„è¿‡æœŸ socket çš„æ•°é‡, å¦‚æœè¶…æ—¶çš„ socket è¶…è¿‡äº†è¿™ä¸ªä¸´ç•Œç‚¹, åˆ™åªå¤„ç† 512 ä¸ª, å‰©ä½™ç­‰å¾…ä¸‹æ¬¡å¤„ç†, ä¸»è¦æ˜¯ä¸ºäº†èƒ½åŠæ—¶å¤„ç†å‘ç”Ÿçš„äº‹ä»¶, ä¸è‡³äºåœ¨è¶…æ—¶è¯·æ±‚è¿‡å¤šçš„æ—¶å€™å¯¼è‡´åç»­äº‹ä»¶çš„å¤„ç†è¢«å»¶è¿Ÿ.

```python
MSG_FASTOPEN = 0x20000000
```

<!-- TODO: æš‚æ—¶ä¸çŸ¥è¯¥å¸¸é‡çš„ä½œç”¨ -->

```python
# SOCKS METHOD definition
METHOD_NOAUTH = 0

# SOCKS command definition # è¿™é‡Œçš„å˜é‡æ˜¯ç”± socks åè®®è§„å®šçš„åè®®å¤´çš„å¸¸é‡
CMD_CONNECT = 1
CMD_BIND = 2
CMD_UDP_ASSOCIATE = 3
```

SOCKS5 åè®®è§„å®šçš„è®¤è¯æ–¹æ³•å’Œè¿æ¥è¡Œä¸ºçš„å¸¸é‡å€¼, å¯ä»¥çœ‹çœ‹ [Wikipedia-socks5][Wikipedia-socks5-zh] å…³äº SOCKS5 æ¡æ‰‹åè®®çš„è¯¦ç»†ä»‹ç».

[è‹±æ–‡ç‰ˆä»‹ç»][Wikipedia-socks5-en], ä¸­æ–‡ç‰ˆçš„ Wikipedia æ­£å¸¸æ˜¯æ— æ³•è®¿é—®çš„.

```python
# for each opening port, we have a TCP Relay

# for each connection, we have a TCP Relay Handler to handle the connection

# for each handler, we have 2 sockets:
#    local:   connected to the client
#    remote:  connected to remote server

# for each handler, it could be at one of several stages:

# as sslocal:
# stage 0 auth METHOD received from local, reply with selection message
# stage 1 addr received from local, query DNS for remote
# stage 2 UDP assoc
# stage 3 DNS resolved, connect to remote
# stage 4 still connecting, more data from local received
# stage 5 remote connected, piping local and remote

# as ssserver:
# stage 0 just jump to stage 1
# stage 1 addr received from local, query DNS for remote
# stage 3 DNS resolved, connect to remote
# stage 4 still connecting, more data from local received
# stage 5 remote connected, piping local and remote

STAGE_INIT = 0
STAGE_ADDR = 1
STAGE_UDP_ASSOC = 2
STAGE_DNS = 3
STAGE_CONNECTING = 4
STAGE_STREAM = 5
STAGE_DESTROYED = -1
```

å¯¹äºæ¯ä¸€ä¸ªç›‘å¬çš„ç«¯å£, éƒ½ä¼šæœ‰ä¸€ä¸ª TCPrelay, å¯¹äºæ¯ä¸€æ¬¡è¿æ¥, éƒ½æœ‰ TCPRelayHandler æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚.

å¯¹äºæ¯ä¸€ä¸ª TCPRelayHandler, æˆ‘ä»¬æœ‰ä¸¤ä¸ª socket:

1. local: è¿æ¥ client ç«¯
1. remote: è¿æ¥ remote æœåŠ¡å™¨

å¯¹äºæ¯ä¸€ä¸ª TCPRelayHandler, å®ƒå¿…é¡»å¤„åœ¨è¿™äº›çŠ¶æ€ä¹‹ä¸€(è¿™å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœº, å¦‚æœä½ è¯»è¿‡ TCP çš„åŸç†, ä¼šå‘ç° TCP è¿æ¥ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„çŠ¶æ€æœº, æœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹IBMçš„å®˜æ–¹æ–‡æ¡£, éå¸¸æ£’, åœ¨[è¿™é‡Œ][TCPçŠ¶æ€æœº]):

sslocal çŠ¶æ€:

1. stage 0 æ”¶åˆ° local å‘è¿‡æ¥çš„è®¤è¯ METHOD, ç„¶åå›å¤ç»™ local é€‰æ‹©çš„ä¿¡æ¯
1. stage 1 æ”¶åˆ° local å‘è¿‡æ¥çš„ addr(è¯·æ±‚åœ°å€), å¼€å§‹æŸ¥è¯¢ remote(sslocalç«¯å°±æ˜¯æŸ¥è¯¢ssserveræœåŠ¡å™¨çš„ DNSä¿¡æ¯, ä¹Ÿå°±æ˜¯è¯´åœ¨é…ç½®æ–‡ä»¶é‡Œé¢ä½ å¯ä»¥å¡«å†™ssserverçš„åŸŸå, è€Œä¸ä»…ä»…å¡«å†™ IP åœ°å€) çš„ DNSä¿¡æ¯
1. stage 3 DNS æŸ¥è¯¢æˆåŠŸ, å¼€å§‹è¿æ¥ remote(sslocalå°±æ˜¯è¿æ¥ssserver)
1. stage 4 ä»åœ¨å’Œ remote è¿æ¥ä¸­, å¯ä»¥ä» local è·å–æ›´å¤šä¿¡æ¯äº†, ç­‰ remote ä¸€æ—¦è¿æ¥æˆåŠŸ, å°±å°†è¿™äº›æ•°æ®ä¸€èµ·å‘ç»™ remote
1. stage 5 remote è¿æ¥å»ºç«‹æˆåŠŸ, piping local å’Œ remote

STAGE_DESTORED è¯´æ˜è¯·æ±‚å·²ç»è¢«é”€æ¯, ç³»ç»Ÿèµ„æºå·²ç»è¢«é‡Šæ”¾.

[Wikipedia-socks5-zh]: <https://zh.wikipedia.org/wiki/SOCKS>
[Wikipedia-socks5-en]: <https://en.wikipedia.org/wiki/SOCKS>
[TCPçŠ¶æ€æœº]: <https://www.ibm.com/support/knowledgecenter/en/SSLTBW_2.1.0/com.ibm.zos.v2r1.halu101/constatus.htm>
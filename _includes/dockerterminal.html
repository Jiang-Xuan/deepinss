<!-- Docker çš„å‘½ä»¤è¡Œå·¥å…· -->
<script src="/deepinss/assets/scripts/xterm.js"></script>
<script src="/deepinss/assets/scripts/addons/attach/attach.js"></script>
<link rel="stylesheet" href="/deepinss/assets/css/xterm.css">

<section id="terminal-container-fixed">
  <input type="checkbox" id="terminal-container-checkbox">
  <label id="terminal-container-label" for="terminal-container-checkbox"></label>
  <div id="terminal-container-title">
    åœ¨çº¿å‘½ä»¤è¡Œå·¥å…·
  </div>
  <div id="terminal-container">
    <!-- å‘½ä»¤è¡Œ -->
  </div>
</section>

<style>
  #terminal-container-fixed {
    position: fixed;
    bottom: 0;
    left: 100%;
    height: 620px; /* 576 */
    width: 769px;
    display: flex;
    flex-direction: column;
    margin: 0;
  }
  #terminal-container-fixed label {
    position: absolute;
    top: 0;
    right: 100%;
    height: 30px;
    width: 100%;
    background-color: #33333380;
    transform: translateY(590px);
    z-index: 999;
    opacity: 0;

    transition: .2s ease-in-out;
  }
  #terminal-container-fixed #terminal-container {
    margin-left: -100%;
    margin-right: 100%;
    height: 590px;
    transform: translateY(590px);
    transition: .2s ease-in-out;
  }
  #terminal-container-fixed #terminal-container-title {
    margin-left: -100%;
    margin-right: 100%;
    text-align: center;
    line-height: 30px;
    transform: translateY(590px);
    transition: .2s ease-in-out;
    background-color: rgba(90, 55, 36, 0.5);
    text-shadow: 2px 2px 1px black;
  }
  #terminal-container-fixed #terminal-container-checkbox:checked ~  #terminal-container {
    background-color: black;
    transform: translateY(0px);
  }
  #terminal-container-fixed #terminal-container-checkbox:checked ~ label {
    transform: translateY(0px);
  }
  #terminal-container-fixed #terminal-container-checkbox:checked ~ #terminal-container-title {
    transform: translateY(0px);
  }
  #terminal-container-fixed #terminal-container-checkbox {
    display: none;
  }
</style>

<script>
;(() => {
  var terminalContainerLabel = document.getElementById('terminal-container-label')
  var terminalContainerTitle = document.getElementById('terminal-container-title')
  var dataCount = 0

  terminalContainerLabel.addEventListener('click', connect)

  function connect() {
    terminalContainerLabel.removeEventListener('click', connect)
    setTimeout(() => {
      var term = new Terminal({
        cursorBlink: true,
        cursorStyle: 'underline'
      })
      var terminalContainer = document.getElementById('terminal-container')
      var socket = new WebSocket('ws://127.0.0.1:8080', 'echo-protocol')
      socket.addEventListener('open', () => {
        term.writeln('âœ…  è¿æ¥ä»£ç† WebSocket æœåŠ¡å™¨æˆåŠŸ')
      })
      function countDownloadDataSize(event) {
        // è®¡ç®—å­—ç¬¦ä¸²æš‚ç”¨çš„å­—èŠ‚æ•°
        dataCount += event.data.replace(/[^\x00-\xFF]/g,'**').length

        terminalContainerTitle.textContent = `åœ¨çº¿å‘½ä»¤è¡Œå·¥å…· (ä¸‹è¡Œæµé‡: ${(dataCount/1024).toFixed(3)}K)`
      }
      function handShake(result) {
        var json

        try {
          json = JSON.parse(result.data)
        } catch (e) {
          /* è§£æ JSON å‡ºé”™*/
          /* TODO: handle error */
          debugger
        }

        if (json.code === 201) {
          term.writeln('âœ…  WebSocket ä»£ç†æœåŠ¡å™¨å·²ç»æ¥å—è¿æ¥')
        } else if (json.code === 219) {
          term.writeln('ğŸšš  å°è¯•åˆ›å»º docker å®¹å™¨...')
        } else if (json.code === 200) {
          term.writeln('âœ…  åˆ›å»º docker å®¹å™¨æˆåŠŸ')
        } else if (json.code === 220) {
          term.writeln('ğŸšš  å¯åŠ¨ docker å®¹å™¨æˆåŠŸ, å°è¯•è¿æ¥å®¹å™¨...')
        } else if(json.code === 222) {
          term.writeln('ğŸ¤“  è¿æ¥ container æˆåŠŸ, å·²ç»è¿›å…¥ Linux ç¯å¢ƒ')

          socket.removeEventListener('message', handShake)
          socket.addEventListener('message', countDownloadDataSize)

          term.attach(socket)

          setTimeout(() => {
            term.focus()
          }, 0)
        }
      }
      socket.addEventListener('message', handShake)
      socket.addEventListener('close', () => {
        term.detach(socket)
        term.writeln('\n')
        term.writeln('ğŸ‘½  è¿æ¥å·²ç»ç»ˆæ­¢, å®¹å™¨å·²ç»è¢«é”€æ¯')
      })
      term.open(terminalContainer)
      term.writeln('ğŸ¤ª  Welcome to deepinss é¡¹ç›®')
      term.writeln('ğŸšš  å°è¯•è¿æ¥ä»£ç† WebSocket æœåŠ¡å™¨...')

      terminalContainerLabel.removeEventListener('click', connect)
    }, 0)
  }

})();
</script>